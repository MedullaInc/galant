{% extends "gallant/base_form.html" %}
{% load staticfiles bootstrap %}

{% block ng_app %} ng-app="gallant" {% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static "djng/js/django-angular.min.js" %}"></script>
{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script type="text/javascript">
        app = angular.module('gallant', ['ng.django.forms']);

        app.controller('FormCtrl', function ($scope) {
            $scope.submitForm = function () {
                jQuery('.form').each(function () {
                    jQuery(this).data('serialize', jQuery(this).serialize());
                });

                var form = $scope.{{ form.form_name }};
                var contact_form = $scope.{{ contact_form.form_name }};
                var data = {csrfmiddlewaretoken: '{{csrf_token}}'};

                jQuery.each([form, contact_form], function (i, form) {
                    angular.forEach(form, function (val, key) {
                        if (!key.match(/\$/)) {
                            val.$setDirty();
                            if (val.$viewValue) {
                                data[key] = val.$viewValue;
                            }
                        }
                    });
                });

                if (!form.$invalid && !contact_form.$invalid) {
                    jQuery.post('', data, function (response) {
                        if (response.redirect) {
                            window.location.href = response.redirect;
                        } else {
                            // handle errors
                            var errors = response.errors[0];
                            console.log(errors);
                        }
                    });
                }
            }
        });
    </script>
{% endblock %}

{% block content %}
    <section class="widget">

        <div ng-app="gallant" ng-controller="FormCtrl">
            <form id="main_form" name="{{ form.form_name }}" class="form" method="post" novalidate>

                {% block form_help_text %}
                    {% if help_text %}
                        <p class="title">
                            <i>
                                {{ help_text }}
                            </i>
                        </p>
                    {% endif %}
                {% endblock %}

                {% csrf_token %}
                {{ form.as_div }}
            </form>
            <hr>
            <div class="widget-body">
                <form name="{{ contact_form.form_name }}" class="form" method="post" novalidate>
                    {% csrf_token %}
                    {{ contact_form.as_div }}
                </form>
            </div>

            <div class="form-actions">
                {% block form_actions %}
                    <button id="create_submit" class="btn btn-inverse" type="submit"
                            ng-click="submitForm()">
                        {{ submit_text|default:_("Save") }}
                    </button>
                {% endblock %}
            </div>

        </div>
    </section>
{% endblock %}