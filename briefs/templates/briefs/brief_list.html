{% extends "base_body.html" %}
{% load bootstrap i18n staticfiles %}

{% block page_title %}
    {% if client %}{{ client.name }} - {% endif %}
    <span class="fw-semi-bold">{{ brief_type_title }}{% trans " Briefs" %}</span>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static "js/angular-animate.js" %}"></script>
    <script src="{% static "djng/js/django-angular.js" %}"></script>
{% endblock %}

{% block project_scripts %}
    {{ block.super }}
    {% if DEBUG %}
        <script src="{% static "js/briefs.js" %}"></script>
    {% endif %}

    <script>
        var app = angular.module('brBriefList', [
            'ngResource',
            'ui.bootstrap',
            'ng.django.forms',
            'briefs.controllers.brPopoverController'
        ]);
    </script>
{% endblock %}

{% block extra_wrapper_attrs %} ng-app="brBriefList" {% endblock %}

{% block client_sidebar %}
    {% if client %}
        <a class="collapsed" href="#sidebar-ui" data-toggle="collapse" data-parent="#sidebar">
        <span class="icon">
            <i class="fa fa-building"></i>
        </span>
            {{ client.name }}
            <i class="toggle fa fa-angle-down"></i>
        </a>
        <ul id="sidebar-ui" class="collapse">
            {% url 'client_detail' client.id as client_detail %}
            <li><a href="{{ client_detail }}">Dashboard</a></li>
            {% url 'client_work_detail' client.id as client_work_detail %}
            <li><a href="{{ client_work_detail }}">Projects</a></li>
            {% url 'client_money_detail' client.id as client_money_detail %}
            <li><a href="{{ client_money_detail }}">Payments</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="{% url 'briefs' %}?client_id={{ client.id }}">Briefs</a></li>
            <li><a href="{% url 'quotes' %}?client_id={{ client.id }}">Quotes</a></li>
        </ul>
    {% endif %}
{% endblock %}

{% block content %}

    <script type="text/ng-template" id="addBriefPopoverTemplate.html">
        <a class="from_template_button" ng-click="open()">
            <button type="button" class="btn btn-success btn-sm mt brief_from_template_button">From Template</button>
        </a>
        <a ng-click="addBriefRedirect()">
            <button type="button" class="btn btn-success btn-sm mt brief_from_scratch_button">From Scratch</button>
        </a>
    </script>
    <script type="text/ng-template" id="briefTemplateModalContent.html">
        <div class="modal-header">
            <h2 class="section_title">Select Template</h2>
        </div>
        <div class="modal-body">
            <table st-table="briefTemplate" class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th st-sort="name">{% trans "Name" %}</th>
                    <th st-sort="date">{% trans "Date" %}</th>
                    <th st-sort="language">{% trans "Language" %}</th>
                </tr>
                </thead>
                <tbody ng-include src="'{% static "briefs/html/br_brieftemplate_modal_rows.html" %}'"></tbody>
            </table>
        </div>
    </script>

    <div class="row">

        <div class="row">
            <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
            </div>
            <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                <a href="{% url 'brieftemplates' %}" class="pull-right">
                    <button type="button" class="btn btn-warning">
                        Brief Templates
                    </button>
                </a>
                <button popover-placement="bottom" uib-popover-template="dynamicPopover.templateUrl" id="add_brief" type="button" class="btn btn-success pull-right button-inline" ng-controller="brPopoverController" ng-init="init('{% url "add_brief" %}', language, clientId)" popover-trigger="focus click">
                    <span class="glyphicon glyphicon-plus"></span>
                    Add Brief
                </button>
            </div>
            <br/>
            <br/>
            <br/>
        </div>

    </div>
    <div class="row">
        <div class="col-lg-12 widget">
            <br/>
            <table class="table table-striped">
                <thead>
                <th>{% trans "Last Modified" %}</th>
                <th>{% trans "Title" %}</th>
                <th>{% trans "Status" %}</th>
                </thead>
                {% for brief in object_list %}
                    <tr data-rel="{{ brief.id }}" style="cursor: pointer" class="brief_row">
                        <td>{{ brief.modified|date:'Y-m-d H:i' }}</td>
                        <td>{{ brief.title.get_text }}</td>
                        <td>{{ brief.get_status_display }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4">
                            No briefs yet.
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <div id="add_button_popover" class="popover" style="display: none">
        <a class="from_template_button">
            <button type="button" class="btn btn-default from_template_button">From Template</button>
        </a>
        <a href="{% url 'add_brief' %}{% if client %}?client_id={{ client.id }}{% endif %}">
            <button type="button" class="btn btn-default from_scratch_button">From Scratch</button>
        </a>
    </div>
{% endblock %}


{% block extra_body %}
    <div id="template_select" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="section_title">Select Template</h2>
                </div>
                <div class="modal-body" style="height: 500px; overflow: auto;">
                    <table class="table table-striped table-bordered">
                        <thead>
                        <th><b>{% trans "Name" %}</b></th>
                        <th><b>{% trans "Date" %}</b></th>
                        <th><b>{% trans "Language" %}</b></th>
                        </thead>
                        {% for template in template_list %}
                            <tr data-rel="{{ template.id }}" style="cursor: pointer" class="template_row">
                                <td>{{ template.brief.name }}</td>
                                <td>{{ template.brief.modified|date:'Y-m-d H:i' }}</td>
                                <td>
                                    {% if template.language_list %}
                                        <select class="template_lang form-control" name="language">
                                            {% for code, language in template.language_list %}
                                                <option value="{{ code }}">{{ language }}</option>
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">
                                    No templates yet,
                                    <a href="{% url "add_brief_template" %}">click here to add one.</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="modal-footer">
                </div>
            </div>

        </div>
    </div>
    <script>
        jQuery(document).ready(function ($) {

            $('.table .brief_row').click(function () {
                window.location.href = "{% url 'brief_detail' %}" + $(this).attr('data-rel') +
                        "{% if request.GET.urlencode %}?{% endif %}{{ request.GET.urlencode }}";
            });

            $('.table .template_row').click(function (e) {
                var lang = '{{ LANGUAGE_CODE }}';
                if ($(this).find('select').length) {
                    lang = $(this).find('select').val();
                }
                window.location.href = "{% url 'add_brief' %}" + "?template_id=" +
                        $(this).attr('data-rel') + "&lang=" + lang +
                        "&{{ request.GET.urlencode }}";
            });

            $('.table .template_row select').click(function (e) {
                e.stopPropagation();
            });

            $('.table .template_row select').change(function (e) {
                window.location.href = "{% url 'add_brief' %}" + "?template_id=" +
                        $(this).parents('tr').attr('data-rel') + "&lang=" + $(this).val() +
                        "&{{ request.GET.urlencode }}";
            });

        });
    </script>
{% endblock %}