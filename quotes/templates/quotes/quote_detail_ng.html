{% extends "base_body.html" %}
{% load bootstrap i18n %}
{% load static %}
{% load gallant_tags %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static "js/angular-animate.js" %}"></script>
    <script src="{% static "js/xeditable.min.js" %}"></script>
    <script src="{% static "djng/js/django-angular.min.js" %}"></script>
    <script src="{% static "js/ng-sortable.min.js" %}"></script>
    <script src="{% static "js/smart-table.js" %}"></script>
{% endblock %}

{% block project_scripts %}
    {{ block.super }}
    {% if DEBUG %}
        <script src="{% static "js/quotes.js" %}"></script>
    {% endif %}
{% endblock %}

{% block project_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "css/xeditable.css" %}">
    <link rel="stylesheet" href="{% static "css/ng-sortable.style.min.css" %}">
    <link rel="stylesheet" href="{% static "css/ng-sortable.min.css" %}">
    <style>
        [name="name"] {
            width: 110px;
        }

        [name="quantity"] {
            width: 70px;
        }

        [name="amount"] {
            width: 70px;
        }

        .as-sortable-item {
            border: 0px;
        }

    </style>
{% endblock %}

{% block extra_wrapper_attrs %} ng-app="quote" {% endblock %}

{% block messages %}
    <div gl-alerts></div>
    {{ block.super }}
{% endblock %}

{% block page_title %}
    {% trans "Quote" %}<span class="fw-semi-bold">{% if object.name %} - {{ object.name }}{% endif %}</span>
{% endblock %}

{% block client_sidebar %}
    <a class="collapsed" href="#sidebar-ui" data-toggle="collapse" data-parent="#sidebar">
        <span class="icon">
            <i class="fa fa-building"></i>
        </span>
        {{ object.client.name }}
        <i class="toggle fa fa-angle-down"></i>
    </a>
    <ul id="sidebar-ui" class="collapse">
        {% url 'client_detail' object.client.id as client_detail %}
        <li><a href="{{ client_detail }}">Dashboard</a></li>
        {% url 'client_work_detail' object.client.id as client_work_detail %}
        <li><a href="{{ client_work_detail }}">Projects</a></li>
        {% url 'client_money_detail' object.client.id as client_money_detail %}
        <li><a href="{{ client_money_detail }}">Payments</a></li>
        <li role="separator" class="divider"></li>
        <li><a href="{% url 'briefs' %}?client_id={{ object.client.id }}">Briefs</a></li>
        <li><a href="{% url 'quotes' %}?client_id={{ object.client.id }}">Quotes</a></li>
    </ul>
{% endblock %}


{% block content %}

    {% get_first object.projects as project %}
    {% if object.status == "4" %}
        <div class="alert alert-danger" role="alert">
            <p id="public_link" class="data">
                This quote has been rejected.
            </p>
        </div>
    {% elif object.status == "5" %}
        <div class="alert alert-success" role="alert" style="margin-left: 0px; margin-right: 0px;">
            <p id="public_link" class="data">
                This quote has been accepted.
                {% if project %}
                    Linked project: <a href="{% url 'project_detail' project.id %}">{{ project.name }}</a>
                {% endif %}
            </p>
        </div>
    {% endif %}
    {% if project and object.status != "5" %}
        <div class="alert alert-success" role="alert">
            <p id="public_link" class="data">
                Linked project: <a href="{% url 'project_detail' project.id %}">{{ project.name }}</a>
            </p>
        </div>
    {% endif %}
    <div ng-controller="glFormController"
         ng-init="init('{% firstof language LANGUAGE_CODE %}', '{{ csrf_token }}')">

        <section class="widget">
            <div class="widget-body">
                <div class="widget-top-overflow text-white">
                    <div class="height-100 overflow-hidden">
                        <img class="img-responsive" src="{% static "img/galant/background.jpg" %}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-5 text-center">
                        <div class="post-user post-user-profile">
                            <h4 class="fw-normal">{{ object.name }}</h4>
                            <span class="label label-danger"> {{ object.get_status_display }} </span>

                            {% if object.client %}
                                <ul class="contacts">
                                    <li>
                                        <i class="fa fa-building fa-fw mr-xs"></i><a href="{% url 'client_detail' object.client.id %}"> {{ object.client.name }}</a>
                                    </li>
                                </ul>
                            {% endif %}

                        </div>
                    </div>
                    <div class="col-sm-7">

                        <div gl-add-modal open-fn="editProject" title="Edit Project" modal-instance="modalInstance">
                            <div gl-project-add on-success="projectSaved" project="projectSafe" language="{% firstof language LANGUAGE_CODE %}"></div>
                        </div>

                        <div class="stats-row stats-row-profile mt text-right">
                            <div class="stat-item">
                                <p class="value">{% get_project_services_count request object %}</p>
                                <h5 class="name">Services</h5>
                            </div>
                            <div class="stat-item">
                                <p class="value">{{ object.get_total_cost }}</p>
                                <h5 class="name">Total Cost</h5>
                            </div>
                        </div>
                        <div gl-add-modal open-fn="addProject" title="Add Project" modal-instance="modalInstance">
                            <div gl-project-add project="object" projects="projects"
                                 on-success="modalInstance.dismiss" quote-id="{{ object.pk }}"></div>
                        </div>
                        <p class="text-right mt-lg">
                            {% if object.client.email and object.status == '0' or object.status == '5' %}
                                {% if not project %}
                                    <button type="buton" class="btn btn-success btn-sm mt" ng-click="addProject()">
                                        &nbsp;Add Project
                                        &nbsp;&nbsp;<i class="glyphicon glyphicon-plus"/></i>&nbsp;
                                    </button>
                                {% endif %}
                            {% endif %}
                            <br/>
                            <a href="{% url 'quote_txt' object.id %}">
                                <button type="button" class="btn btn-success btn-sm mt">
                                    &nbsp;{% trans "Copy & Paste Text Version" %}
                                    &nbsp;&nbsp;<i class="fa fa-copy"/></i>&nbsp;
                                </button>
                            </a>
                            <a href="{% url 'add_quote_template' quote_id=object.id %}">
                                <button type="button" class="btn btn-success btn-sm mt" title="Create template from this quote.">
                                    &nbsp;{% trans "Use as Template" %}
                                    &nbsp;&nbsp;<i class="fa fa-file-text"/></i>&nbsp;
                                </button>
                            </a>
                            <a href="{% url 'quote_pdf' object.id %}">
                                <button type="button" class="btn btn-success btn-sm mt">
                                    &nbsp;{% trans "PDF Version" %}
                                    &nbsp;&nbsp;<i class="fa fa-file-pdf-o"/></i>&nbsp;
                                </button>
                            </a>
                            {% if object.status != "0" and object.status != "5" and object.status != "6" %}
                                <br/>
                                <form action="" method="POST" class="pull-right">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="reject">
                                    <button id="quote_reject" type="submit" class="btn btn-danger btn-sm">
                                        &nbsp;{% trans "Reject Quote" %}
                                        &nbsp;&nbsp;<i class="glyphicon glyphicon-remove"/></i>&nbsp;
                                    </button>
                                </form>
                                <form action="" method="POST" onsubmit="return confirm('{% trans "After accepting the quote, a project will be automatically created and linked to the quote. The link will be shown at the top of the page." %}');" class="pull-right mr">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="accept">
                                    <button id="quote_accept" type="submit" class="btn btn-success btn-sm">
                                        &nbsp;{% trans "Accept Quote" %}
                                        &nbsp;&nbsp;<i class="glyphicon glyphicon-ok"/></i>&nbsp;
                                    </button>
                                </form>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <div qt-quote-form quote-id="{{ object.pk }}" quote="object" endpoint="objectEndpoint"
             language="currentLanguage" forms="forms" delete-object="deleteObject"
             client-id="{{ client.id }}" project-id="{{ project.id }}" quote-id="{{ quote.id }}"
             template-id="{{ template_id }}" bool-template="False" id-type="{{ id_type }}" submit="submitForm"
             service-currency="{{ user.currency }}">
        </div>

    </div>

{% endblock %}

{% block extra_body %}
    <div id="quote_select" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="section_title">Select Quote</h2>
                    <p>New projects must be linked to a quote. Please select an unlinked quote.</p>
                </div>
                <div class="modal-body" style="height: 500px; overflow: auto;">
                    {% with object_list=quote_list %}
                        {% include "quotes/quote_table.html" %}
                    {% endwith %}
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <script>
        jQuery('#add_project_button').click(function ($) {
            $('#quote_select').modal('show');
        });

        jQuery('.table .project_row').click(function ($) {
            window.location.href = "{% url 'project_detail' %}" + $(this).attr('data-rel')
        });

        jQuery('.table .quote_row').click(function ($, e) {
            window.location.href = "{% url 'add_project' %}" + $(this).attr('data-rel');
        });
    </script>
{% endblock %}