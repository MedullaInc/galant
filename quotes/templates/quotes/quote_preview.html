{% load staticfiles bootstrap i18n %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>{% block head_title %}Galant{% endblock head_title %}</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="{% static "css/flat-ui.css" %}">
        <link rel="stylesheet" href="{% static "css/icon-font.css" %}">
        <link rel="stylesheet" href="{% static "css/animations.css" %}">
        <link rel="stylesheet" href="{% static "css/bootstrap.min.css" %}">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="{% static "js/jquery-latest.min.js" %}"></script>
        <script src="{% static "js/bootstrap.min.js" %}"></script>
        <script src="{% static "js/flat-ui.min.js" %}"></script>
        <script src="{% static "js/modernizr.custom.js" %}"></script>
        <script src="{% static "js/page-transitions.js" %}"></script>
        <script src="{% static "js/startup-kit.js" %}"></script>
        <script src="{% static "js/gallant.js" %}"></script>

        {% block pdf_style %}
            <link rel="stylesheet" href="{% static "css/quote.css" %}">
        {% endblock pdf_style %}

        <script>

            $(document).ready(function () {

                // Initialize variables
                var page_height = 0;
                var initial_page_height = 0;

                // Reorder page elements
                function reorder_page_elements() {

                    // Page number
                    var $page_number = 0

                    // Reset page numbers
                    set_page_numbers();

                    // Check
                    $page_number += 1;

                    // Move Services
                    pdf_elements = $('.page-wrapper').find('.pdf_element.service');

                    if (pdf_elements.length > 0) {
                        //remove_elements_from_page(pdf_elements);
                        var new_page = add_new_page($page_number);
                        insert_elements_in_page(new_page, pdf_elements);
                        $page_number += 1;
                    }

                    // Move Prices
                    pdf_elements = $('.page-wrapper').find('.pdf_element.not_in_page.prices');

                    if (pdf_elements.length > 0) {
                        //remove_elements_from_page(pdf_elements);
                        var new_page = add_new_page($page_number);
                        insert_elements_in_page(new_page, pdf_elements);
                        $page_number += 1;
                    }

                    // Move Margin
                    pdf_elements = $('.page-wrapper').find('.pdf_element.margin');

                    if (pdf_elements.length > 0) {
                        //remove_elements_from_page(pdf_elements);
                        var new_page = add_new_page($page_number);
                        insert_elements_in_page(new_page, pdf_elements);
                    }

                    // Reset page numbers
                    set_page_numbers();

                    // Paginate
                    paginate();

                }

                // Go through each page-wrapper instance.
                function paginate() {
                    // Initialize
                    $pages_count = $('body').find(".page-wrapper").length;

                    // Paginate all sections
                    $('body').find(".page-wrapper").each(function (page_index) {
                        // Paginate
                        check_page_height(page_index);
                        set_page_numbers();
                    });

                    if ($('body').find(".page-wrapper").length > $pages_count) {
                        paginate();
                    }

                }

                // Check page height, and adjust pages accordingly.
                function check_page_height(page_id) {

                    // INITIALIZE variables
                    var $reboot = 0;
                    var $page_id = page_id;
                    var page = $('#page_' + $page_id);

                    {% block pagination_init %}
                        page_height = 4970; // Use this for wkhtmltopdf.
                    {% endblock pagination_init %}

                    initial_page_height = page_height;

                    // START PAGING

                    $(page).find('.pdf_element').each(function () {

                        var pdf_elements = [];

                        if ($(this).hasClass('prices') && ($(this).height() > page_height)) {

                            // Element is prices, and greater than page_height -    Divide by sub-elements
                            var element = $(this);
                            page_by_rows(element, pdf_elements, $page_id, initial_page_height, page_height);

                            // Reset page height
                            page_height = initial_page_height;

                        } else if ($(this).height() > initial_page_height) {

                            // Element is greater than initial_page_height -        Divide by words
                            var element = $(this);

                            // Marked as positioned in new page
                            $(this).addClass("in_page");
                            $(this).removeClass("not_in_page");

                            pdf_elements = $(this).parent().find('.pdf_element.not_in_page');

                            page_by_words(element, pdf_elements, $page_id, initial_page_height, page_height);

                            // Reset page height
                            page_height = initial_page_height;

                            // Restart
                            $reboot = 0;

                        } else if ($(this).height() > page_height) {

                            // Element is greater than page_height -                Send to new page.
                            pdf_elements = $(this).parent().find('.pdf_element.not_in_page');

                            // Create new page
                            $page_id = add_new_page($page_id);

                            // Send elements to new page
                            insert_elements_in_page($page_id, pdf_elements);

                            // Marked as positioned in new page
                            $(this).addClass("in_page");
                            $(this).removeClass("not_in_page");

                            // Reset page height
                            page_height = initial_page_height;

                            // Restart
                            $reboot = 1;
                            return false;

                        } else {

                            // Just subtract element height from page_height
                            page_height = page_height - $(this).height();

                            // Mark element as positioned on page to be able to select other elements.
                            $(this).addClass("in_page");
                            $(this).removeClass("not_in_page");

                        }

                        if ($reboot == 1) {
                            return false;
                        }

                    });

                    if ($reboot == 1) {
                        check_page_height($page_id);
                    }

                    // END PAGING

                }

                function insert_elements_in_page(page_id, pdf_elements) {
                    //  Insert pdf_elements in content's container element
                    $(pdf_elements).each(function () {
                        $('#container_page_' + page_id + '').append($(this));
                    });
                }

                function set_page_numbers() {
                    $('body').find(".page-wrapper").each(function (page_index, page) {
                        var page_number = page_index + 1;
                        $(this).attr('id', 'page_' + page_number);
                        $(this).find(".content .holder .container").attr('id', 'container_page_' + page_number);
                        $(this).find('footer #page_number').html('<strong>' + page_number + ' / ' + $(".page-wrapper").length + '</strong>');
                    });
                }

                function add_new_page(page_id) {

                    var new_page_id = page_id + 1;

                    // Append new page-wrapper element to body after current page.
                    $('<div class="page-wrapper" id="page_' + new_page_id + '"></div>').insertAfter('#page_' + page_id);

                    // Copy header, content, footer
                    $('.header').first().clone().appendTo('#page_' + new_page_id);
                    $('#page_' + new_page_id).append('<section class="content"><div class="holder v-center"><div class="container" id="container_page_' + new_page_id + '"></div></div></section>')
                    $('.footer').first().clone().appendTo('#page_' + new_page_id);

                    // Set page numbers
                    set_page_numbers();

                    return new_page_id

                }

                function page_by_rows(element, pdf_elements, page_id, total_height, current_height) {
                    // Iterate row by row and create new pages as needed.

                    var rows = element.find('.row');
                    var page_number = page_id;

                    $(rows).each(function (i, row) {

                        // If title height is greater than remaining page height,
                        if ($(row)[0].clientHeight > current_height) {
                            // Update page_id to new page's id.
                            page_number = add_new_page(page_id);
                            // Reset current_height
                            current_height = total_height;
                        } else {
                            // Update current_height
                            current_height = current_height - $(row)[0].clientHeight;
                            // Mark element as positioned on page to be able to select other elements.
                        }

                        // Send to page
                        insert_elements_in_page(page_number, $(row));

                    });

                }

                function page_by_words(element, pdf_elements, page_id, total_height, current_height) {

                    // Detach element
                    $(element).detach();

                    // Initiate variables
                    var $page_number = page_id;

                    // Create pdf_element
                    var pdf_element = '<div class="pdf_element service in_page"></div>';

                    // Element title
                    var $title = $(element).find(".section_title")[0];

                    // Add row to pdf_element
                    pdf_element = $(pdf_element).append('<div class="row new"></div>');

                    // Add title to row
                    $(pdf_element).find('.row').append($title);

                    // Insert pdf_element into DOM
                    insert_elements_in_page($page_number, pdf_element);

                    //console.log(pdf_element);

                    // Check pdf_element height, change to new page if needed
                    if ($(pdf_element).height() > current_height) {
                        // Update page_id to new page's id.
                        $page_number = add_new_page($page_number);

                        // Reset current_height
                        current_height = total_height;

                        // Insert pdf_element into DOM
                        insert_elements_in_page($page_number, pdf_element);

                        // Update height
                        current_height = current_height - $(pdf_element).height();
                    } else {
                        // Update height
                        current_height = current_height - $(pdf_element).height();
                    }

                    // Get element paragraphs
                    var $paragraphs = $(element).find('p');

                    // Iterate over each paragraph

                    // Create pdf_element
                    var pdf_element = '<div class="pdf_element service in_page"></div>';

                    // Add row to pdf_element
                    pdf_element = $(pdf_element).append('<div class="row new"></div>');

                    var $create_section_content = 0;
                    var new_section_content = '';

                    $($paragraphs).each(function (p, paragraph) {

                        // Initialize variables
                        var words = $(this).text().split(" ");
                        words = words.filter(function(w){return w != ""});
                        words = words.filter(function(w){return w != "\n"});

                        var $create_p = 0;
                        var new_p = '';

                        // Iterate over each word in paragraph and insert into p
                        $(words).each(function (i, word) {

                            if (word != "") {

                                // If there is no section_content, create a new one
                                if ($create_section_content == 0) {
                                    new_section_content = '<div class="col-xs-offset-4 col-xs-8 section_content new"></div>';
                                    $create_section_content = 1;
                                }

                                // If there is no p, create a new one
                                if ($create_p == 0) {
                                    new_p = '<p id="page_' + $page_number + '_element_' + p + '"></p>';
                                    $create_p = 1;
                                }

                                // Insert word into p
                                new_p = $(new_p).append(word + ' ');

                                // Build pdf_element
                                new_section_content = $(new_section_content).append(new_p);
                                $(pdf_element).find('.row').html(new_section_content);

                                // Insert pdf_element into DOM
                                insert_elements_in_page($page_number, pdf_element);

                                // Check height
                                if (((current_height - $(pdf_element).height()) / page_height) < 0.1) {
                                    
                                    // Update page_id to new page's id.
                                    $page_number = add_new_page($page_number);

                                    // Reset current_height
                                    current_height = total_height;

                                    // Create pdf_element
                                    pdf_element = '<div class="pdf_element service in_page"></div>';

                                    // Add row to pdf_element
                                    pdf_element = $(pdf_element).append('<div class="row new"></div>');

                                    $create_section_content = 0;
                                    new_section_content = '';

                                    $create_p = 0;
                                    new_p = '';

                                }

                            }

                        });

                    });

                }

                reorder_page_elements();

            });

        </script>

    {% endblock head %}
    {% block extra_head %}
    {% endblock extra_head %}
</head>
<body>
{% block body %}

    <div class="page-wrapper">

        <header class="header">
            <div class="container">
                <div class="row header_top">
                    <div class="col-xs-12">
                        <p>
                            <strong>{{ object.client.name }}</strong><br/>
                            {{ object.name }}
                        </p>
                    </div>
                </div>
                <div class="row header_bottom">
                    <div class="col-xs-4">
                        <p>
                            <strong>{{ object.user.name }}</strong><br/>
                            {{ object.user.email }}<br/>
                            {{ object.user.contact_info.phone_number }}
                        </p>
                    </div>
                    <div class="col-xs-4">
                        <p>
                            <strong>{% trans "Address" %}</strong><br/>
                            {{ object.user.contact_info.address }}<br/>
                            {{ object.user.contact_info.address_2 }}<br/>
                        </p>
                    </div>
                    <div class="col-xs-4">
                        <p>
                            <br/>
                            {{ object.user.contact_info.city }},
                            {{ object.user.contact_info.state }}<br/>
                            {{ object.user.contact_info.country }} {{ object.user.contact_info.zip }}<br/>
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <section class="content">
            <div class="holder v-center">
                <div class="container">
                    {% for section in object.all_sections %}
                        {% if section.service %}
                            {% with service=section.service %}
                                <div class="pdf_element not_in_page {{ service.name }}">

                                    <div class="row">
                                        <div class="col-xs-offset-2 col-xs-8 section_title">
                                            <h2>
                                                {{ service.name.get_text }}
                                            </h2>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-xs-offset-4 col-xs-8 section_content">
                                            {{ service.description.get_text|linebreaks }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-xs-offset-4 col-xs-4 section_content">
                                            <p>
                                                {% trans "Service Cost:" %}
                                            </p>
                                        </div>
                                        <div class="col-xs-4 section_content">
                                            <p>
                                                {{ service.cost }} &times; {{ service.quantity }}
                                            </p>
                                        </div>
                                    </div>

                                </div>
                            {% endwith %}
                        {% else %}
                            <div class="pdf_element not_in_page">
                                <div class="row">
                                    <div class="col-xs-offset-2 col-xs-8 section_title">
                                        <h2>
                                            {{ section.title.get_text }}
                                        </h2>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-offset-4 col-xs-8 section_content">
                                        {{ section.text.get_text|linebreaks }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="pdf_element not_in_page prices">
                        <div class="row title">
                            <div class="col-xs-offset-2 col-xs-10 section_title">
                                <h2>
                                    {% trans "Prices" %}
                                </h2>
                            </div>
                        </div>
                        <div class="row title">
                            <div class="col-xs-offset-4 col-xs-2 section_content">
                                <p>
                                    <strong>{% trans "Service" %}</strong>
                                </p>
                            </div>
                            <div class="col-xs-2 section_content">
                                <p>
                                    <strong>{% trans "Quantity" %}</strong>
                                </p>
                            </div>
                            <div class="col-xs-2 section_content">
                                <p>
                                    <strong>{% trans "Unit Price" %}</strong>
                                </p>
                            </div>
                            <div class="col-xs-2 section_content">
                                <p>
                                    <strong>{% trans "Subtotal" %}</strong>
                                </p>
                            </div>
                        </div>
                        {% for section in object.all_sections %}
                            {% if section.service %}
                                {% with service=section.service %}
                                    <div class="row content">
                                        <div class="col-xs-offset-4 col-xs-2 section_content">
                                            <p>
                                                {{ service.name.get_text }}
                                            </p>
                                        </div>
                                        <div class="col-xs-2 section_content">
                                            <p>
                                                {{ service.quantity }}
                                            </p>
                                        </div>
                                        <div class="col-xs-2 section_content">
                                            <p>
                                                {{ service.cost }}
                                            </p>
                                        </div>
                                        <div class="col-xs-2 section_content">
                                            <p>
                                                {{ service.get_total_cost }}
                                            </p>
                                        </div>
                                    </div>
                                {% endwith %}
                            {% endif %}
                        {% endfor %}

                        <div class="row">
                            <div class="col-xs-offset-8 col-xs-2 section_content">
                                <p>
                                    <strong>{% trans "Total" %}</strong>
                                </p>
                            </div>
                            <div class="col-xs-2 section_content">
                                <p>
                                    <strong>{{ object.get_total_cost }}</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="container">
                <div class="row content_footer">
                    <div class="col-xs-4">
                        <p>
                            {% trans "Created using" %} {{ site.domain }}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-11">
                    </div>
                    <div class="col-xs-1">
                        <p class="pull-right" id="page_number">
                        </p>
                    </div>
                </div>
            </div>
        </footer>

    </div>

{% endblock body %}

{% block extra_body %}
{% endblock extra_body %}
</body>
</html>