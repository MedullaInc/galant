{% extends "base_sidebar.html" %}
{% load bootstrap i18n %}
{% load static %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static "js/angular.js" %}"></script>
    <script src="{% static "js/angular-resource.js" %}"></script>
    <script src="{% static "js/xeditable/xeditable.min.js" %}"></script>
    <script src="{% static "js/ui-bootstrap-tpls.js" %}"></script>
    <script src="{% static "djangular/js/django-angular.min.js" %}"></script>
    <script src="{% static "gallant/js/directives/glForm.js" %}"></script>
    <script src="{% static "gallant/js/controllers/glFormController.js" %}"></script>
    <script src="{% static "quotes/js/services/qtServices.js" %}"></script>
    <script src="{% static "quotes/js/directives/qtForm.js" %}"></script>
    <script src="{% static "quotes/js/directives/qtList.js" %}"></script>
    <script src="{% static "quotes/js/apps/quotes.js" %}"></script>
    <script src="{% static "js/ng-sortable/ng-sortable.min.js" %}"></script>

{% endblock %}

{% block section_title %}
    {% trans "Quotes" %}
{% endblock %}

{% block sidebar %}

    <a>
        <button id="add_quote_button" type="button" class="btn btn-default sidebar">
            {% trans "Add New Quote" %}
        </button>
    </a>

    <a href="{% url 'quote_templates' %}">
        <button type="button" class="btn btn-default sidebar">
            {% trans "Templates" %}
        </button>
    </a>

{% endblock %}

{% block center_content %}
    <div ng-app="quote" ng-controller="glFormController"
         ng-init="init('{% firstof language LANGUAGE_CODE %}', '{{ csrf_token }}')">
        <div qt-quote-list quote-id="{{ object.pk }}" quote="object" endpoint="objectEndpoint"
             language="currentLanguage" forms="forms"
             client-id="{{ client.id }}" project-id="{{ project.id }}" quote-id="{{ quote.id }}"
             template-id="{{ template_id }}">
        </div> 
    </div>
        <div id="add_button_popover" class="popover" style="display: none">
        <a class="from_template_button">
            <button type="button" class="btn btn-default from_template_button sidebar">From Template</button>
        </a>
        <a href="{% url 'add_quote' %}">
            <button type="button" class="btn btn-default from_scratch_button sidebar">From Scratch</button>
        </a>
    </div>
{% endblock %}

{% block extra_body %}
    <div id="template_select" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="section_title">Select Template</h2>
                </div>
                <div class="modal-body" style="height: 500px; overflow: auto;">
                    <table class="table table-striped table-bordered">
                        <thead>
                        <th><b>{% trans "Name" %}</b></th>
                        <th><b>{% trans "Date" %}</b></th>
                        <th><b>{% trans "Lanugage" %}</b></th>
                        </thead>
                        {% for template in template_list %}
                            <tr data-rel="{{ template.id }}" style="cursor: pointer" class="template_row">
                                <td>{{ template.quote.name }}</td>
                                <td>{{ template.quote.modified|date:'Y-m-d H:i' }}</td>
                                <td>
                                    {% if template.language_list %}
                                        <select class="template_lang form-control" name="language">
                                            {% for code, language in template.language_list %}
                                                <option value="{{ code }}">{{ language }}</option>
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">
                                    No templates yet, <a href="{% url "add_quote_template" %}">click here to add one.</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <script>
        $('#add_quote_button').popover({
            html: true,
            container: 'body',
            content: $('#add_button_popover').html(),
            title: false,
            placement: "bottom"
        }).click(function () {
            $('body').on('click', '.popover-content > button.from_template_button', function () {
                $('#add_quote_button').popover('hide');
                $('#template_select').modal('show');
            });
            $('body').on('click', '.popover-content > a.from_template_button', function () {
                $('#add_quote_button').popover('hide');
                $('#template_select').modal('show');
            });
        });

        $('body').on('click', function (e) {
            var p = $('#add_quote_button');
            if (!p.is(e.target) && p.has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                p.popover('hide');
            }
        });

        $(window).resize(function(){
           $('#add_quote_button').popover('hide');
        });

        $('.table .template_row').click(function (e) {
            var lang = '{{ LANGUAGE_CODE }}';
            if ($(this).find('select').length) {
                lang = $(this).find('select').val();
            }
            window.location.href = "{% url 'add_quote' %}" + "?template_id=" +
                    $(this).attr('data-rel') + "&lang=" + lang;
        });

        $('.table .template_row select').click(function (e) {
            e.stopPropagation();
        });

        $('.table .template_row select').change(function (e) {
            window.location.href = "{% url 'add_quote' %}" + "?template_id=" + $(this).parents('tr').attr('data-rel') + "&lang=" + $(this).val();
        });
    </script>
{% endblock %}